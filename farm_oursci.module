<?php

/**
 * Farm Our-Sci module.
 */

/**
 * Implements hook_menu().
 */
function farm_oursci_menu() {
  $items = array();
  $items['api/oursci'] = array(
    'page callback' => 'farm_oursci_api_callback',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Our-sci API callback.
 */
function farm_oursci_api_callback() {

  // If this is a POST request, process the data.
  if ($_SERVER['REQUEST_METHOD'] == 'POST') {

    // Pull the data from the request.
    $data = drupal_json_decode(file_get_contents("php://input"));

    // If data was posted, process it.
    if (!empty($data)) {
      farm_oursci_process_data($data);
    }
  }

  // Return 200 code, always.
  return MENU_FOUND;
}

/**
 * Process data.
 */
function farm_oursci_process_data($data) {

  // Set the timestamp.
  $timestamp = REQUEST_TIME;
  if (!empty($data['timestamp'])) {
    $timestamp = $data['timestamp'];
  }

  // We will create an observation log.
  $type = 'farm_observation';

  // Give it a name.
  $name = 'Our Sci Observation';
  if (!empty($data['title'])) {
    $name = $data['title'];
  }

  // Mark the log as done.
  $done = TRUE;

  // Don't reference any assets.
  $assets = array();

  // Assemble quantity measurements.
  $measurements = array();
  if (!empty($data['quantities'])) {
    foreach ($data['quantities'] as $qty) {
      $measurements[] = $qty;
    }
  }

  // Create a quantity log.
  farm_quantity_log_create($type, $name, $timestamp, $done, $assets, $measurements);
}
